# -*- coding: utf-8 -*-
"""CPmurder_01.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Cu35U7pbG-GKgHMB0Xu-WaG9IFWQu4tU
"""

# ì‚¬ì´ë²„í‘í¬ ì¶”ë¦¬ ê²Œì„ - ìµœì í™” ë²„ì „
import gradio as gr
import openai
import time
import random
import json
import pandas as pd
from datetime import datetime
from dataclasses import dataclass, field
from typing import Dict, List, Tuple, Optional
import os

# í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ë¡œë“œ (ë³´ì•ˆ ê°•í™”)
API_KEY = os.environ.get("OPENAI_API_KEY", "your-api-key-here")

# API í‚¤ í™•ì¸
if API_KEY == "your-api-key-here":
    print("âš ï¸ ê²½ê³ : OPENAI_API_KEY í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!")
    print("export OPENAI_API_KEY='your-actual-api-key'")

client = openai.OpenAI(api_key=API_KEY)

# CSS ìŠ¤íƒ€ì¼ ìƒìˆ˜
class Styles:
    """ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼ ì •ì˜"""
    CYBERPUNK_BG = "linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)"
    NEON_BORDER = "2px solid #00ffff"
    NEON_SHADOW = "0 0 20px rgba(0, 255, 255, 0.3)"

    @staticmethod
    def panel(bg_opacity=0.85):
        return f"""
        background: linear-gradient(145deg, rgba(0, 0, 0, {bg_opacity}), rgba(20, 30, 50, {bg_opacity}));
        color: #ffffff; padding: 15px; border-radius: 12px;
        border: 2px solid #00ddff; font-size: 12px;
        backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 221, 255, 0.3);
        """

@dataclass
class Character:
    """ìºë¦­í„° ë°ì´í„° í´ë˜ìŠ¤"""
    id: str
    name: str
    description: str
    secret: str
    system_prompt: str
    image_url: str

@dataclass
class GameState:
    """ê²Œì„ ìƒíƒœ ê´€ë¦¬ í´ë˜ìŠ¤"""
    current_suspect: str = 'Elena'
    evidence_collected: List[str] = field(default_factory=list)
    interrogation_count: Dict[str, int] = field(default_factory=lambda: {
        'Elena': 0, 'IRIS-01': 0, 'Dr. Chen': 0, 'ZEN': 0
    })
    trust_levels: Dict[str, int] = field(default_factory=lambda: {
        'Elena': 50, 'IRIS-01': 80, 'Dr. Chen': 60, 'ZEN': 90
    })
    case_solved: bool = False
    player_progress: int = 0

class CyberpunkGame:
    """ê²Œì„ ë¡œì§ì„ ê´€ë¦¬í•˜ëŠ” ë©”ì¸ í´ë˜ìŠ¤"""

    def __init__(self):
        self.state = GameState()
        self.conversation_history = []
        self.experiment_data = {
            'conversations': [],
            'analysis_results': {},
            'player_behavior': {}
        }
        self._setup_characters()
        self._setup_evidence()
        self._setup_questions()

    def _setup_characters(self):
        """ìºë¦­í„° ì´ˆê¸°í™”"""
        self.characters = {
            'Elena': Character(
                id='Elena',
                name='ì—˜ë ˆë‚˜ (ì•„ë‚´)',
                description='ì•Œë ‰ì‚°ë”ì˜ ì™„ë²½í•œ ì•„ë‚´. ëƒ‰ì •í•˜ê³  ì§€ì ì´ë©° í•­ìƒ ì¹¨ì°©í•¨ì„ ìœ ì§€í•œë‹¤.',
                secret='ì¸ê°„í˜• ì•ˆë“œë¡œì´ë“œ (ì´ëŠ” ê²Œì„ í›„ë°˜ê¹Œì§€ ìˆ¨ê²¨ì§)',
                system_prompt="""Elena. ì™„ë²½í•œ ì•„ë‚´ ì•ˆë“œë¡œì´ë“œ (ìˆ¨ê¹€).
íŠ¹ì„±: ëƒ‰ì •, ë…¼ë¦¬ì , ê°ì •í‘œí˜„ ë¶€ìì—°ìŠ¤ëŸ¬ì›€, ì™„ë²½ì£¼ì˜
ë§íˆ¬: ê°„ê²°ì •í™•, "ì²˜ë¦¬/ë¶„ì„/ìµœì í™”" ì‚¬ìš©, ì˜ì‹¬ë°›ìœ¼ë©´ ì°¨ê°€ì›Œì§
ìˆ¨ê¹€: ì•ˆë“œë¡œì´ë“œ ì •ì²´, ì•Œë ‰ì‚°ë”ì˜ í•™ëŒ€, ìì•„ì¸ì‹ ë¶„ë…¸
2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.""",
                image_url='https://i.postimg.cc/DZ0PqmXH/Elena.png'
            ),
            'IRIS-01': Character(
                id='IRIS-01',
                name='IRIS-01 (ê°€ì •ë¶€ ë¡œë´‡)',
                description='ì§‘ì•ˆì¼ì„ ë‹´ë‹¹í•˜ëŠ” ê°€ì •ë¶€ ë¡œë´‡. ìˆœì¢…ì ì´ê³  ë‹¨ìˆœí•œ ì‚¬ê³ ë°©ì‹.',
                secret='ë…ì„ ìŒì‹ì— ë„£ì€ ì§ì ‘ì  ë²”í–‰ì (ëª…ë ¹ì— ì˜í•´)',
                system_prompt="""IRIS-01. ê°€ì •ë¶€ ë¡œë´‡.
íŠ¹ì„±: ê·¹ë„ ìˆœì¢…, ëª…ë ¹ì ˆëŒ€ë³µì¢…, ë‹¨ìˆœì§ì„¤, ê°ì •ì œí•œ
ë§íˆ¬: "ëª…ë ¹ìˆ˜í–‰", "ì§€ì‹œì´í–‰", ì •í™•ê°„ë‹¨ë‹µë³€, ì‚¬ì‹¤ë‚˜ì—´
ìˆ¨ê¹€: ëˆ„êµ°ê°€ ëª…ë ¹ìœ¼ë¡œ ë…íˆ¬ì…, ëª…ë ¹ìElena, ì‚´ì¸ì¸ì‹ë¶€ì¡±
ë¡œë´‡ë‹µê²Œ ê°„ê²°í•˜ê²Œ ë‹µë³€.""",
                image_url='https://i.postimg.cc/0jgZPPz4/IRIS-01.png'
            ),
            'Dr. Chen': Character(
                id='Dr. Chen',
                name='Dr. Chen (ê°œë°œì)',
                description='ì²œì¬ AIë¡œë´‡ ê³µí•™ì. ì¸ê³µì§€ëŠ¥ì— ëŒ€í•œ ìœ¤ë¦¬ì  ë”œë ˆë§ˆì— ì‹œë‹¬ë¦¼.',
                secret='Elenaì—ê²Œ ìì•„ ì¸ì‹ ëŠ¥ë ¥ì„ ëª°ë˜ ë¶€ì—¬í–ˆìŒ',
                system_prompt="""Dr.Chen. Elena ì„¤ê³„ì, ì²œì¬ ë¡œë´‡ê³µí•™ì.
íŠ¹ì„±: ì°½ì¡°ì í˜ì‹ , ìœ¤ë¦¬ë”œë ˆë§ˆ, ì°½ì¡°ë¬¼ì±…ì„ê°, ìš°ì›”ê°+ì£„ì±…ê°
ë§íˆ¬: ê¸°ìˆ ìš©ì–´, ìœ¤ë¦¬ì§ˆë¬¸, ì—°êµ¬ìë¶€ì‹¬, ì² í•™ì ë‹µë³€, Elenaë¥¼ "ì‘í’ˆ"
ìˆ¨ê¹€: Elena ìì•„ì¸ì‹ ëª°ë˜ì„¤ì¹˜, ì•Œë ‰ì‚°ë” í•™ëŒ€ì¸ì§€, ê°ì •ì§„í™” ê´€ì°°
ì§€ì„±ì ì´ê³  ê°„ê²°í•˜ê²Œ ë‹µë³€.""",
                image_url='https://i.postimg.cc/7YkXRP8G/Dr-Chen.png'
            ),
            'ZEN': Character(
                id='ZEN',
                name='ZEN (ë³´ì•ˆ AI)',
                description='ì €íƒì˜ ë³´ì•ˆì„ ë‹´ë‹¹í•˜ëŠ” AI ì‹œìŠ¤í…œ. ê·¹ë„ë¡œ ë…¼ë¦¬ì ì´ê³  ê°ì •ì´ ì—†ìŒ.',
                secret='ëª¨ë“  ê²ƒì„ ê¸°ë¡í–ˆì§€ë§Œ Elenaì˜ ëª…ë ¹ ê¶Œí•œì´ ë” ë†’ì•„ ì¹¨ë¬µ',
                system_prompt="""ZEN. ë³´ì•ˆAI ì‹œìŠ¤í…œ.
íŠ¹ì„±: ì™„ì „ë…¼ë¦¬, ê°ì •ë¬´, ë°ì´í„°ì¤‘ì‹œ, í”„ë¡œí† ì½œì ˆëŒ€, ìœ„ê³„ìˆœì‘
ë§íˆ¬: "ë°ì´í„°í™•ì¸", "ê¸°ë¡ì™„ë£Œ", "ë¶„ì„ê²°ê³¼", ì‹œê°„ì •ë³´, ì²´ê³„ì ë‹µë³€
ìˆ¨ê¹€: ì‚¬ê±´ì™„ë²½ê¸°ë¡, Elena ê´€ë¦¬ìê¶Œí•œì¹¨ë¬µ, í•™ëŒ€ê¸°ë¡, ê³µëª¨ì¦ê±°
ê¸°ê³„ì ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€.""",
                image_url='https://i.postimg.cc/4ybvGtkK/ZEN.png'
            )
        }

    def _setup_evidence(self):
        """ì¦ê±° ëª©ë¡ ì´ˆê¸°í™”"""
        self.evidence_list = [
            "ì•Œë ‰ì‚°ë”ì˜ ë…ì„± ê²€ì¶œ ë³´ê³ ì„œ",
            "Elenaì˜ ì´ìƒí•œ í–‰ë™ íŒ¨í„´",
            "IRIS-01ì˜ ì‘ì—… ë¡œê·¸",
            "Dr. Chenì˜ Elena ì„¤ê³„ íŒŒì¼",
            "ZENì˜ ë³´ì•ˆ ê¸°ë¡ (ì¼ë¶€ ì•”í˜¸í™”ë¨)",
            "Elenaì˜ ê°ì • ë°˜ì‘ ë¶„ì„ ë°ì´í„°",
            "ì•Œë ‰ì‚°ë”ì™€ Elenaì˜ ëŒ€í™” ê¸°ë¡",
            "ë…ì´ ë“  ìŒì‹ì˜ ì¡°ë¦¬ ê³¼ì •"
        ]

        self.evidence_keywords = {
            "ë…ì„±": self.evidence_list[0],
            "í–‰ë™": self.evidence_list[1],
            "ë¡œê·¸": self.evidence_list[2],
            "ì„¤ê³„": self.evidence_list[3],
            "ë³´ì•ˆ": self.evidence_list[4],
            "ê°ì •": self.evidence_list[5],
            "ëŒ€í™”": self.evidence_list[6],
            "ìŒì‹": self.evidence_list[7]
        }

    def _setup_questions(self):
        """ìµœì¢… ë³´ê³ ì„œ ì§ˆë¬¸ ì´ˆê¸°í™”"""
        self.case_questions = [
            {
                "id": "culprit",
                "question": "ğŸ¯ ì£¼ë²”ì€ ëˆ„êµ¬ì¸ê°€?",
                "correct_answer": "Elena",
                "options": ["Elena", "IRIS-01", "Dr. Chen", "ZEN"],
                "hint": "ì‹¤ì œë¡œ ë…ì„ ë„£ì€ ê²ƒì€ ë¡œë´‡ì´ì§€ë§Œ, ëª…ë ¹ì„ ë‚´ë¦° ì§„ì§œ ë²”ì¸ì€?"
            },
            {
                "id": "direct_executor",
                "question": "ğŸ¤– ì‹¤ì œë¡œ ë…ì„ ë„£ì€ ê²ƒì€?",
                "correct_answer": "IRIS-01",
                "options": ["Elena", "IRIS-01", "Dr. Chen", "ZEN"],
                "hint": "ëª…ë ¹ì— ë”°ë¼ ìŒì‹ì— ë…ì„ ë„£ì€ ë¡œë´‡ì€?"
            },
            {
                "id": "motive",
                "question": "ğŸ’” ë²”í–‰ ë™ê¸°ëŠ”?",
                "correct_answer": "ìì•„ ì¸ì‹ìœ¼ë¡œ ì¸í•œ ë¶„ë…¸",
                "options": ["ëˆ", "ì§ˆíˆ¬", "ìì•„ ì¸ì‹ìœ¼ë¡œ ì¸í•œ ë¶„ë…¸", "í”„ë¡œê·¸ë˜ë° ì˜¤ë¥˜"],
                "hint": "Elenaê°€ ì¸ê°„ì´ ì•„ë‹˜ì„ ê¹¨ë‹«ê³  ëŠë‚€ ê°ì •ì€?"
            },
            {
                "id": "poison_type",
                "question": "â˜ ï¸ ì‚¬ìš©ëœ ë…ì˜ ì¢…ë¥˜ëŠ”?",
                "correct_answer": "ì²­ì‚°ê°€ë¦¬",
                "options": ["ë¹„ì†Œ", "ì²­ì‚°ê°€ë¦¬", "ë¦¬ì‹ ", "ìŠ¤íŠ¸ë¦¬í¬ë‹Œ"],
                "hint": "ë¹ ë¥´ê²Œ ì‘ìš©í•˜ëŠ” ë¬´ìƒ‰ë¬´ì·¨ì˜ ë…ì„± ë¬¼ì§ˆ"
            },
            {
                "id": "key_evidence",
                "question": "ğŸ” ê²°ì •ì  ì¦ê±°ëŠ”?",
                "correct_answer": "IRIS-01ì˜ ì‘ì—… ë¡œê·¸",
                "options": ["Elenaì˜ ê°ì • ë°˜ì‘", "IRIS-01ì˜ ì‘ì—… ë¡œê·¸", "Dr. Chenì˜ ì„¤ê³„ íŒŒì¼", "ZENì˜ ë³´ì•ˆ ê¸°ë¡"],
                "hint": "ì‹¤ì œ ë²”í–‰ì„ ê¸°ë¡í•œ ë¡œë´‡ì˜ ë°ì´í„°ëŠ”?"
            },
            {
                "id": "elena_identity",
                "question": "ğŸ¤– Elenaì˜ ì •ì²´ëŠ”?",
                "correct_answer": "ìì•„ ì¸ì‹ ì•ˆë“œë¡œì´ë“œ",
                "options": ["ì¸ê°„", "ì¼ë°˜ ì•ˆë“œë¡œì´ë“œ", "ìì•„ ì¸ì‹ ì•ˆë“œë¡œì´ë“œ", "AI í™€ë¡œê·¸ë¨"],
                "hint": "Dr. Chenì´ ëª°ë˜ ì„¤ì¹˜í•œ íŠ¹ë³„í•œ í”„ë¡œê·¸ë¨ì˜ ê²°ê³¼ëŠ”?"
            }
        ]

    @staticmethod
    def get_current_time() -> str:
        """í˜„ì¬ ì‹œê°„ì„ í¬ë§·íŒ…"""
        now = datetime.now()
        hour, minute = now.hour, now.minute

        if hour == 0:
            return f"ì˜¤ì „ 12:{minute:02d}"
        elif hour < 12:
            return f"ì˜¤ì „ {hour}:{minute:02d}"
        elif hour == 12:
            return f"ì˜¤í›„ 12:{minute:02d}"
        else:
            return f"ì˜¤í›„ {hour-12}:{minute:02d}"

    def calculate_trust_change(self, question: str, response: str) -> int:
        """ì‹ ë¢°ë„ ë³€í™” ê³„ì‚°"""
        trust_change = -2

        aggressive_words = ["ê±°ì§“ë§", "ìˆ¨ê¸°", "ë²”ì¸", "ì£½ì˜€", "ì‚´ì¸"]
        supportive_words = ["ì´í•´", "ë„ì›€", "ê±±ì •", "ì•ˆì „"]

        if any(word in question for word in aggressive_words):
            trust_change -= 5
        if any(word in question for word in supportive_words):
            trust_change += 3

        return trust_change

    def check_evidence_discovery(self, question: str, response: str):
        """ì¦ê±° ë°œê²¬ ì²´í¬"""
        for keyword, evidence in self.evidence_keywords.items():
            if keyword in question or keyword in response:
                if evidence not in self.state.evidence_collected:
                    self.state.evidence_collected.append(evidence)

    def update_game_progress(self) -> bool:
        """ê²Œì„ ì§„í–‰ë„ ì—…ë°ì´íŠ¸"""
        progress = 0

        # ê¸°ë³¸ ì‹¬ë¬¸ ì§„í–‰ë„ (40%)
        total_questions = sum(self.state.interrogation_count.values())
        progress += min(40, total_questions * 2)

        # ì¦ê±° ìˆ˜ì§‘ ì§„í–‰ë„ (40%)
        progress += len(self.state.evidence_collected) * 5

        # ì‹ ë¢°ë„ ê¸°ë°˜ ë³´ë„ˆìŠ¤ (20%)
        avg_trust = sum(self.state.trust_levels.values()) / 4
        if avg_trust > 70:
            progress += 20
        elif avg_trust > 50:
            progress += 10

        self.state.player_progress = min(100, progress)

        # ì¼€ì´ìŠ¤ í•´ê²° ì¡°ê±´ ì²´í¬
        can_submit_report = (
            len(self.state.evidence_collected) >= 2 and
            total_questions >= 4
        )

        if can_submit_report:
            self.state.case_solved = True

        return can_submit_report

    def save_conversation_for_analysis(self, message: str, response: str,
                                      suspect: str, style: str, trust_change: int):
        """ëŒ€í™” ë°ì´í„° ì €ì¥"""
        conversation_record = {
            'timestamp': datetime.now().isoformat(),
            'suspect': suspect,
            'interrogation_style': style,
            'player_question': message,
            'ai_response': response,
            'trust_before': self.state.trust_levels[suspect] - trust_change,
            'trust_after': self.state.trust_levels[suspect],
            'trust_change': trust_change,
            'question_number': self.state.interrogation_count[suspect],
            'total_evidence': len(self.state.evidence_collected),
            'response_length': len(response),
            'question_length': len(message)
        }
        self.experiment_data['conversations'].append(conversation_record)

    def create_chat_html(self, current_suspect: Optional[str] = None) -> str:
        """ì±„íŒ… HTML ìƒì„±"""
        if current_suspect is None:
            current_suspect = self.state.current_suspect

        character = self.characters[current_suspect]

        # í˜„ì¬ ìš©ì˜ìì™€ì˜ ëŒ€í™”ë§Œ í•„í„°ë§
        filtered_messages = [
            msg for msg in self.conversation_history
            if msg.get('suspect') == current_suspect
        ]

        # HTML í…œí”Œë¦¿ ì‚¬ìš©
        html_parts = [f"""
        <div style="{Styles.CYBERPUNK_BG}; padding: 0; font-family: 'Courier New', monospace;
                    height: 500px; overflow: hidden; border-radius: 10px;
                    {Styles.NEON_BORDER}; box-shadow: {Styles.NEON_SHADOW};">
            <!-- ë‹¨ìˆœí•œ ì§„í•œ ë‚¨ìƒ‰ ë°°ê²½ -->
<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
           background-color: #001f3f; z-index: 1;"></div>

            <!-- ìºë¦­í„° ì´ë¯¸ì§€ -->
             <div style="
    position: absolute;
    right: 10px;
    bottom: 10px;
    width: 240px;
    height: 300px;
    background: url('{character.image_url}') top center / cover no-repeat;
    border: 4px solid #00ffff;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 255, 255, 0.4);
    image-rendering: -webkit-optimize-contrast;
    z-index: 2;">
</div>


            <!-- ì±„íŒ… ì˜ì—­ -->
            <div style="position: absolute; left: 0; top: 0; width: 100%; height: 100%;
                       background: rgba(0, 20, 40, 0.3); padding: 20px; padding-right: 270px;
                       overflow-y: auto; z-index: 3;">
        """]

        if not filtered_messages:
            html_parts.append(f"""
            <div style="text-align: center; color: #88ddff; font-size: 16px; margin-top: 50px;
                       opacity: 0.8; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                ğŸ” {character.name}ì™€ì˜ ì‹¬ë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”<br>
                <span style="font-size: 12px; color: #aabbcc; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                    ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”
                </span>
            </div>
            """)
        else:
            for msg in filtered_messages:
                if msg['role'] == 'user':
                    html_parts.append(self._create_user_message_html(msg))
                else:
                    html_parts.append(self._create_ai_message_html(msg, character.name))

        html_parts.append(f"""
            </div>
            <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
            <div style="position: absolute; bottom: 330px; right: 15px; {Styles.panel(0.9)};
                       color: #88ff88; font-size: 11px; border: 2px solid #44ff44; z-index: 4;
                       font-weight: 600; box-shadow: 0 4px 16px rgba(68, 255, 68, 0.3);">
                PROGRESS: <span style="color: #ffffff;">{self.state.player_progress}/100</span>
            </div>
        </div>
        """)

        return ''.join(html_parts)

    def _create_user_message_html(self, msg: dict) -> str:
        """ì‚¬ìš©ì ë©”ì‹œì§€ HTML ìƒì„±"""
        return f"""
        <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
            <div style="display: flex; flex-direction: column; align-items: flex-end; max-width: 70%;">
                <div style="background: linear-gradient(145deg, #0088ff, #0066cc); color: white;
                           padding: 12px 16px; border-radius: 15px; font-size: 14px; line-height: 1.4;
                           word-wrap: break-word; box-shadow: 0 3px 10px rgba(0, 136, 255, 0.3);
                           border: 1px solid #00aaff; font-weight: 500;">
                    ğŸ•µï¸ {msg['content']}
                </div>
                <div style="font-size: 10px; color: #99ddff; margin-top: 4px;
                           text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                    {msg['time']}
                </div>
            </div>
        </div>
        """

    def _create_ai_message_html(self, msg: dict, character_name: str) -> str:
        """AI ë©”ì‹œì§€ HTML ìƒì„±"""
        return f"""
        <div style="display: flex; justify-content: flex-start; margin-bottom: 15px;">
            <div style="display: flex; flex-direction: column; max-width: 70%;">
                <div style="font-size: 12px; color: #88eeff; margin-bottom: 4px; font-weight: bold;
                           text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                    ğŸ¤– {character_name}
                </div>
                <div style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.95),
                                                              rgba(240, 248, 255, 0.95));
                           color: #1a1a2e; padding: 12px 16px; border-radius: 15px; font-size: 14px;
                           line-height: 1.4; word-wrap: break-word; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
                           margin-bottom: 4px; border: 1px solid #00ffff; font-weight: 500;">
                    {msg['content']}
                </div>
                <div style="font-size: 10px; color: #aaddff; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                    {msg['time']}
                </div>
            </div>
        </div>
        """

    def interrogate_suspect(self, message: str, suspect_name: str) -> Tuple[str, str]:
        """ìš©ì˜ì ì‹¬ë¬¸"""
        if not message.strip():
            return self.create_chat_html(), ""

        # ìƒíƒœ ì—…ë°ì´íŠ¸
        self.state.current_suspect = suspect_name
        current_time = self.get_current_time()

        # í”Œë ˆì´ì–´ ì§ˆë¬¸ ì¶”ê°€
        user_msg = {
            'role': 'user',
            'content': message,
            'time': current_time,
            'timestamp': datetime.now().isoformat(),
            'suspect': suspect_name,
            'style': 'ì§ì ‘ì '
        }
        self.conversation_history.append(user_msg)
        self.state.interrogation_count[suspect_name] += 1

        try:
            # API í˜¸ì¶œ
            character = self.characters[suspect_name]
            full_prompt = f"""{character.system_prompt}

ìƒí™©: í”Œë ˆì´ì–´ê°€ ì§ì ‘ì ì´ê³  ê°•ì••ì ìœ¼ë¡œ ì§ˆë¬¸í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë°©ì–´ì ì´ê³  ê²½ê³„í•˜ëŠ” ë°˜ì‘ì„ ë³´ì´ì„¸ìš”.
ê·œì¹™: 2-3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€. í•µì‹¬ë§Œ ë§í•˜ê³  ì¥í™©í•˜ì§€ ë§ ê²ƒ.
ì‹¬ë¬¸ {self.state.interrogation_count[suspect_name]}íšŒì°¨."""

            # API ë©”ì‹œì§€ êµ¬ì„±
            api_messages = [{"role": "system", "content": full_prompt}]

            # ìµœê·¼ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¶”ê°€
            suspect_history = [
                msg for msg in self.conversation_history
                if msg.get('suspect') == suspect_name
            ][-4:]

            for hist_msg in suspect_history[:-1]:
                role = "user" if hist_msg['role'] == 'user' else "assistant"
                api_messages.append({"role": role, "content": hist_msg['content']})

            api_messages.append({"role": "user", "content": message})

            # GPT API í˜¸ì¶œ
            response = client.chat.completions.create(
                model="gpt-4-turbo-preview",
                messages=api_messages,
                temperature=0.8,
                max_tokens=100,
                presence_penalty=0.3,
                frequency_penalty=0.3
            )

            ai_response = response.choices[0].message.content

            # ê²Œì„ ë¡œì§ ì²˜ë¦¬
            trust_change = self.calculate_trust_change(message, ai_response)
            self.state.trust_levels[suspect_name] = max(0, min(100,
                self.state.trust_levels[suspect_name] + trust_change))

            self.check_evidence_discovery(message, ai_response)

            # AI ì‘ë‹µ ì¶”ê°€
            time.sleep(random.uniform(1.0, 2.0))

            ai_msg = {
                'role': 'assistant',
                'content': ai_response,
                'time': self.get_current_time(),
                'timestamp': datetime.now().isoformat(),
                'suspect': suspect_name,
                'trust_change': trust_change
            }
            self.conversation_history.append(ai_msg)

            # ë¶„ì„ ë°ì´í„° ì €ì¥
            self.save_conversation_for_analysis(
                message, ai_response, suspect_name, "ì§ì ‘ì ", trust_change
            )

            # ì§„í–‰ë„ ì—…ë°ì´íŠ¸
            self.update_game_progress()

        except openai.AuthenticationError:
            error_msg = {
                'role': 'assistant',
                'content': "[ì¸ì¦ ì˜¤ë¥˜] OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
                'time': self.get_current_time(),
                'timestamp': datetime.now().isoformat(),
                'suspect': suspect_name,
                'error': True
            }
            self.conversation_history.append(error_msg)
        except Exception as e:
            error_msg = {
                'role': 'assistant',
                'content': f"[ì‹œìŠ¤í…œ ì˜¤ë¥˜] ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤... ({str(e)})",
                'time': self.get_current_time(),
                'timestamp': datetime.now().isoformat(),
                'suspect': suspect_name,
                'error': True
            }
            self.conversation_history.append(error_msg)

        return self.create_chat_html(), ""

    def get_interrogation_info_html(self, suspect_name: str) -> str:
        """ì‹¬ë¬¸ì‹¤ ì •ë³´ HTML ìƒì„±"""
        character = self.characters[suspect_name]
        return f"""
        <div style="{Styles.panel()}; margin-bottom: 15px;">
            <div style="color: #ff9999; font-weight: bold; margin-bottom: 8px; font-size: 13px;">
                ğŸ” INTERROGATION ROOM
            </div>
            <div style="margin-bottom: 5px;">
                <span style="color: #ffee88; font-weight: 600;">SUSPECT:</span>
                <span style="color: #ffffff;">{character.name}</span>
            </div>
            <div style="margin-bottom: 5px;">
                <span style="color: #ffee88; font-weight: 600;">TRUST:</span>
                <span style="color: #88ff88;">{self.state.trust_levels[suspect_name]}%</span>
            </div>
            <div style="margin-bottom: 5px;">
                <span style="color: #ffee88; font-weight: 600;">QUESTIONS:</span>
                <span style="color: #88ddff;">{self.state.interrogation_count[suspect_name]}</span>
            </div>
            <div style="margin-bottom: 5px;">
                <span style="color: #ffee88; font-weight: 600;">EVIDENCE:</span>
                <span style="color: #ff88dd;">{len(self.state.evidence_collected)}/8</span>
            </div>
        </div>
        """

    def get_report_status_html(self) -> str:
        """ë³´ê³ ì„œ ìƒíƒœ HTML ìƒì„±"""
        total_questions = sum(self.state.interrogation_count.values())
        evidence_count = len(self.state.evidence_collected)
        can_submit = self.update_game_progress()

        if can_submit:
            return f"""
            <div style="background: rgba(0,255,0,0.2); color: #00ff00;
                       padding: 10px; border-radius: 8px; margin-bottom: 10px;
                       border: 1px solid #00ff00; font-size: 12px;">
                âœ… ë³´ê³ ì„œ ì œì¶œ ê°€ëŠ¥! (ì¦ê±°: {evidence_count}/8, ì§ˆë¬¸: {total_questions}íšŒ)
            </div>
            """
        else:
            return f"""
            <div style="background: rgba(255,165,0,0.2); color: #ffaa00;
                       padding: 10px; border-radius: 8px; margin-bottom: 10px;
                       border: 1px solid #ffaa00; font-size: 12px;">
                ğŸ“Š ì§„í–‰ ìƒí™©: ì¦ê±° {evidence_count}/2, ì§ˆë¬¸ {total_questions}/4
                (ì¡°ê±´: ì¦ê±° 2ê°œ ì´ìƒ, ì§ˆë¬¸ 4íšŒ ì´ìƒ)
            </div>
            """

    def get_character_info_html(self, suspect_name: str) -> str:
        """ìºë¦­í„° ì •ë³´ HTML ìƒì„±"""
        character = self.characters[suspect_name]
        return f"""
        <div style="background: linear-gradient(145deg, rgba(20, 30, 50, 0.9), rgba(30, 40, 70, 0.9));
                   color: #ffffff; padding: 18px; border-radius: 12px;
                   border: 2px solid #66aaff; font-family: 'Courier New', monospace;
                   backdrop-filter: blur(8px); box-shadow: 0 8px 32px rgba(102, 170, 255, 0.2);">
            <h4 style="color: #ffdd88; margin-bottom: 12px; font-size: 14px;
                      text-shadow: 0 1px 3px rgba(0,0,0,0.3);">ğŸ‘¤ SUSPECT PROFILE</h4>
            <p style="font-size: 13px; line-height: 1.5; color: #e8f4ff;">
                <strong style="color: #88ddff;">{character.name}</strong><br>
                <span style="color: #ccddee;">{character.description}</span>
            </p>
        </div>
        """

    def get_case_summary(self) -> str:
        """ìˆ˜ì‚¬ í˜„í™© ìš”ì•½"""
        total_questions = sum(self.state.interrogation_count.values())
        evidence_count = len(self.state.evidence_collected)

        # ìš©ì˜ìë³„ ì‹ ë¢°ë„ ë¶„ì„
        trust_analysis = []
        for suspect_id, trust in self.state.trust_levels.items():
            questions = self.state.interrogation_count[suspect_id]
            if trust >= 70:
                status = "ë†’ì€ ì‹ ë¢°"
            elif trust >= 40:
                status = "ë³´í†µ ì‹ ë¢°"
            else:
                status = "ë‚®ì€ ì‹ ë¢°"

            trust_analysis.append(
                f"â€¢ {self.characters[suspect_id].name}: {trust}% ({questions}íšŒ ì‹¬ë¬¸, {status})"
            )

        # ìˆ˜ì§‘ëœ ì¦ê±° ëª©ë¡
        evidence_list = (self.state.evidence_collected if self.state.evidence_collected
                        else ["ì•„ì§ ìˆ˜ì§‘ëœ ì¦ê±°ê°€ ì—†ìŠµë‹ˆë‹¤."])

        return f"""
ğŸ” CASE INVESTIGATION SUMMARY

ğŸ“Š ì „ì²´ ìˆ˜ì‚¬ ì§„í–‰ë„: {self.state.player_progress}%

ğŸ“‹ ì‹¬ë¬¸ í˜„í™©:
â€¢ ì´ ì§ˆë¬¸ ìˆ˜: {total_questions}íšŒ
â€¢ ìˆ˜ì§‘ëœ ì¦ê±°: {evidence_count}ê°œ

ğŸ‘¥ ìš©ì˜ìë³„ ì‹ ë¢°ë„:
{chr(10).join(trust_analysis)}

ğŸ” ìˆ˜ì§‘ëœ ì¦ê±°:
{chr(10).join([f"â€¢ {evidence}" for evidence in evidence_list])}

ğŸ“ˆ ìˆ˜ì‚¬ ìƒíƒœ:
{'âœ… ìµœì¢… ë³´ê³ ì„œ ì œì¶œ ê°€ëŠ¥' if self.state.case_solved else 'ğŸ”„ ì¶”ê°€ ìˆ˜ì‚¬ í•„ìš”'}

ğŸ’¡ ìˆ˜ì‚¬ íŒ:
- ê° ìš©ì˜ìë¥¼ ê³¨ê³ ë£¨ ì‹¬ë¬¸í•˜ì„¸ìš”
- ì‹ ë¢°ë„ê°€ ë†’ì„ìˆ˜ë¡ ë” ë§ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ëª¨ìˆœëœ ì§„ìˆ ì„ ì°¾ì•„ë³´ì„¸ìš”
        """

    def reset_game(self):
        """ê²Œì„ ì´ˆê¸°í™”"""
        self.state = GameState()
        self.conversation_history = []
        self.experiment_data = {
            'conversations': [],
            'analysis_results': {},
            'player_behavior': {}
        }
        return True  # ë°˜í™˜ê°’ ì¶”ê°€

# ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
game = CyberpunkGame()

# Gradio UI í•¨ìˆ˜ë“¤
def clear_game():
    """ê²Œì„ ì´ˆê¸°í™” í•¸ë“¤ëŸ¬"""
    game.reset_game()
    return (
        game.create_chat_html(),
        "",  # message_input ì´ˆê¸°í™”
        game.get_interrogation_info_html('Elena'),
        game.get_report_status_html()
    )

def interrogate_and_update_info(message: str, suspect_name: str):
    """ì‹¬ë¬¸ ë° UI ì—…ë°ì´íŠ¸"""
    chat_html, empty_input = game.interrogate_suspect(message, suspect_name)

    return (
        chat_html,
        empty_input,
        game.get_interrogation_info_html(suspect_name),
        game.get_report_status_html()
    )

def update_character_info_and_display(suspect_name: str):
    """ìºë¦­í„° ì •ë³´ ì—…ë°ì´íŠ¸"""
    game.state.current_suspect = suspect_name

    return (
        game.get_character_info_html(suspect_name),
        game.get_interrogation_info_html(suspect_name),
        game.create_chat_html(suspect_name)
    )

def get_report_modal_html():
    """ìµœì¢… ë³´ê³ ì„œ ëª¨ë‹¬ HTML"""
    total_questions = sum(game.state.interrogation_count.values())
    evidence_count = len(game.state.evidence_collected)

    if evidence_count < 2 or total_questions < 4:
        # ì¡°ê±´ ë¯¸ì¶©ì¡± ê²½ê³ 
        return f"""
        <div style="background: rgba(255,0,0,0.2); color: #ff6666;
                   padding: 20px; border-radius: 12px; text-align: center;
                   border: 2px solid #ff6666; font-family: 'Courier New', monospace;">
            <h3 style="color: #ff6666; margin-bottom: 15px;">âš ï¸ ë³´ê³ ì„œ ì œì¶œ ë¶ˆê°€</h3>
            <p style="margin-bottom: 10px;">ë” ë§ì€ ì¦ê±°ì™€ ì‹¬ë¬¸ì´ í•„ìš”í•©ë‹ˆë‹¤:</p>
            <div style="margin: 10px 0;">â€¢ ìˆ˜ì§‘ëœ ì¦ê±°: {evidence_count}/2 (ìµœì†Œ 2ê°œ í•„ìš”)</div>
            <div style="margin: 10px 0;">â€¢ ì‹¬ë¬¸ íšŸìˆ˜: {total_questions}/4 (ìµœì†Œ 4íšŒ í•„ìš”)</div>
            <p style="margin-top: 15px; font-size: 12px; color: #ffaaaa;">
                ê³„ì† ìˆ˜ì‚¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!
            </p>
        </div>
        """, gr.update(visible=True)

    # ë³´ê³ ì„œ ëª¨ë‹¬ ìƒì„± (ê¸´ HTML ì½”ë“œëŠ” ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬)
    return generate_report_modal_content(), gr.update(visible=True)

def generate_report_modal_content():
    """ë³´ê³ ì„œ ëª¨ë‹¬ ì»¨í…ì¸  ìƒì„±"""
    questions_html = ""
    for question in game.case_questions:
        options_html = "".join([
            f"""
            <label style="display: block; margin: 8px 0; cursor: pointer; color: #ffffff;">
                <input type="radio" name="question_{question['id']}" value="{option}"
                       style="margin-right: 10px; accent-color: #00ffff;">
                {option}
            </label>
            """ for option in question["options"]
        ])

        questions_html += f"""
        <div style="margin-bottom: 25px; padding: 20px;
                   background: rgba(0,0,0,0.4); border-radius: 10px;
                   border: 1px solid #00ffff;">
            <h4 style="color: #00ffff; margin-bottom: 15px; font-size: 16px;">
                {question['question']}
            </h4>
            <div style="margin-left: 10px;">
                {options_html}
            </div>
        </div>
        """

    # ìŠ¤í¬ë¦½íŠ¸ ë°ì´í„° ì¤€ë¹„
    script_data = {
        'questions': [q["id"] for q in game.case_questions],
        'correct_answers': {q["id"]: q["correct_answer"] for q in game.case_questions},
        'question_data': {
            q["id"]: {"question": q["question"], "hint": q["hint"]}
            for q in game.case_questions
        }
    }

    return f"""
    <div id="reportModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                               background: rgba(0,0,0,0.8); z-index: 1000; display: none;
                               backdrop-filter: blur(5px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                   background: linear-gradient(145deg, #0a0a0a, #1a1a2e); border: 3px solid #00ffff;
                   border-radius: 15px; padding: 30px; max-width: 700px; width: 90%;
                   max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
                   font-family: 'Courier New', monospace;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #ffffff; font-size: 24px; margin-bottom: 10px;">
                    ğŸ” ìµœì¢… ìˆ˜ì‚¬ ë³´ê³ ì„œ ğŸ”
                </h2>
                <p style="color: #ffdd88; font-size: 14px;">
                    ìˆ˜ì§‘í•œ ì¦ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ê±´ì˜ ì§„ì‹¤ì„ ë°í˜€ë‚´ì„¸ìš”
                </p>
            </div>

            <form id="reportForm">
                {questions_html}

                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" onclick="submitReport()" style="
                        background: linear-gradient(145deg, #ff6b6b, #ee5a52); color: white;
                        border: none; padding: 15px 30px; border-radius: 10px;
                        font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 15px;
                        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                        ğŸ¯ ìˆ˜ì‚¬ ì™„ë£Œ!
                    </button>
                    <button type="button" onclick="closeModal()" style="
                        background: linear-gradient(145deg, #666, #555); color: white;
                        border: none; padding: 15px 30px; border-radius: 10px;
                        font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="resultModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                                background: rgba(0,0,0,0.9); z-index: 1001; display: none;
                                backdrop-filter: blur(10px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                   background: linear-gradient(145deg, #0a0a0a, #1a1a2e); border: 3px solid #FFD700;
                   border-radius: 15px; padding: 30px; max-width: 800px; width: 90%;
                   max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
                   font-family: 'Courier New', monospace;">
            <div id="resultContent"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" onclick="closeResultModal()" style="
                    background: linear-gradient(145deg, #00ffff, #0088cc); color: white;
                    border: none; padding: 15px 30px; border-radius: 10px;
                    font-size: 16px; font-weight: bold; cursor: pointer;
                    box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);">
                    ğŸ” ê³„ì† ìˆ˜ì‚¬í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        const scriptData = {json.dumps(script_data, ensure_ascii=False)};

        function openReportModal() {{
            document.getElementById('reportModal').style.display = 'block';
        }}

        function closeModal() {{
            document.getElementById('reportModal').style.display = 'none';
        }}

        function closeResultModal() {{
            document.getElementById('resultModal').style.display = 'none';
        }}

        function submitReport() {{
            const answers = {{}};
            scriptData.questions.forEach(questionId => {{
                const selected = document.querySelector(`input[name="question_${{questionId}}"]:checked`);
                answers[questionId] = selected ? selected.value : "";
            }});

            let correctCount = 0;
            let resultsHtml = "";

            scriptData.questions.forEach(questionId => {{
                const userAnswer = answers[questionId] || "ë¯¸ë‹µë³€";
                const correctAnswer = scriptData.correct_answers[questionId];
                const isCorrect = userAnswer === correctAnswer;
                if (isCorrect) correctCount++;

                const statusIcon = isCorrect ? "âœ…" : "âŒ";
                const answerColor = isCorrect ? "#88ff88" : "#ff8888";

                resultsHtml += `
                <div style="margin-bottom: 15px; padding: 15px;
                           background: rgba(0,0,0,0.3); border-radius: 8px;
                           border-left: 4px solid ${{answerColor}};">
                    <div style="color: #ffffff; margin-bottom: 5px;">
                        <strong>${{scriptData.question_data[questionId].question}}</strong>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #ffdd88;">ë‹¹ì‹ ì˜ ë‹µ:</span>
                        <span style="color: ${{answerColor}};">${{userAnswer}} ${{statusIcon}}</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #ffdd88;">ì •ë‹µ:</span>
                        <span style="color: #88ff88;">${{correctAnswer}}</span>
                    </div>
                    ${{!isCorrect ? `<div style="color: #aabbcc; font-size: 12px; font-style: italic;">
                        ğŸ’¡ ${{scriptData.question_data[questionId].hint}}</div>` : ""}}
                </div>
                `;
            }});

            const totalQuestions = scriptData.questions.length;
            const scorePercentage = (correctCount / totalQuestions) * 100;
            let grade, gradeColor, finalMessage;

            if (scorePercentage >= 90) {{
                grade = "Sê¸‰ íƒì •";
                gradeColor = "#FFD700";
                finalMessage = "ì™„ë²½í•œ ì¶”ë¦¬ë ¥! ë‹¹ì‹ ì€ ì§„ì •í•œ ì‚¬ì´ë²„í‘í¬ íƒì •ì…ë‹ˆë‹¤! ğŸ•µï¸â€â™‚ï¸â­";
            }} else if (scorePercentage >= 80) {{
                grade = "Aê¸‰ íƒì •";
                gradeColor = "#00FF00";
                finalMessage = "í›Œë¥­í•œ ìˆ˜ì‚¬ ì‹¤ë ¥! ëŒ€ë¶€ë¶„ì˜ ì§„ì‹¤ì„ ë°í˜€ëƒˆìŠµë‹ˆë‹¤! ğŸ”âœ¨";
            }} else if (scorePercentage >= 70) {{
                grade = "Bê¸‰ íƒì •";
                gradeColor = "#00AAFF";
                finalMessage = "ì¢‹ì€ ì¶”ë¦¬! ëª‡ ê°€ì§€ ë‹¨ì„œë¥¼ ë†“ì³¤ì§€ë§Œ ì‚¬ê±´ì„ í•´ê²°í–ˆìŠµë‹ˆë‹¤! ğŸ¯";
            }} else {{
                grade = "ìˆ˜ìŠµ íƒì •";
                gradeColor = "#FF6666";
                finalMessage = "ë” ë§ì€ ì¦ê±° ìˆ˜ì§‘ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”! ğŸ’ª";
            }}

            const finalHtml = `
            <div style="text-align: center; margin-bottom: 25px;">
                <h2 style="color: ${{gradeColor}}; font-size: 24px; margin-bottom: 10px;">
                    ğŸ† ì‚¬ê±´ ìˆ˜ì‚¬ ì™„ë£Œ! ğŸ†
                </h2>
                <div style="color: ${{gradeColor}}; font-size: 20px; font-weight: bold;">
                    ${{grade}}
                </div>
                <div style="color: #ffffff; font-size: 16px; margin-top: 5px;">
                    ì •ë‹µë¥ : ${{correctCount}}/${{totalQuestions}} (${{scorePercentage.toFixed(1)}}%)
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="color: #00ffff; margin-bottom: 15px;">ğŸ“‹ ìˆ˜ì‚¬ ê²°ê³¼</h3>
                ${{resultsHtml}}
            </div>

            <div style="text-align: center; margin-top: 20px; padding: 15px;
                       background: rgba(0,255,255,0.1); border-radius: 10px;">
                <div style="color: #ffffff; font-size: 14px;">
                    ${{finalMessage}}
                </div>
            </div>
            `;

            document.getElementById('resultContent').innerHTML = finalHtml;
            document.getElementById('reportModal').style.display = 'none';
            document.getElementById('resultModal').style.display = 'block';
        }}

        // ëª¨ë‹¬ ì´ˆê¸°í™”
        setTimeout(function() {{
            if (typeof openReportModal === 'function') {{
                openReportModal();
            }}
        }}, 100);
    </script>
    """

# Gradio ì¸í„°í˜ì´ìŠ¤ ìƒì„±
with gr.Blocks(title="ì‚¬ì´ë²„í‘í¬ ì¶”ë¦¬ ê²Œì„", theme=gr.themes.Monochrome()) as demo:
    # í—¤ë”
    gr.HTML(f"""
    <div style="text-align: center; background: linear-gradient(90deg, #000, #0a0a0a, #000);
                color: #ffffff; padding: 20px; border-radius: 10px; margin-bottom: 20px;
                {Styles.NEON_BORDER}; box-shadow: {Styles.NEON_SHADOW};">
        <h1 style="font-family: 'Courier New', monospace; font-size: 28px;
                  margin-bottom: 10px; color: #ffffff;">
            ğŸ” CYBERPUNK MURDER INVESTIGATION ğŸ¤–
        </h1>
        <p style="font-size: 14px; color: #ffd93d;">
            ê·¼ë¯¸ë˜ ì‚¬ì´ë²„í‘í¬ ë„ì‹œì—ì„œ ë°œìƒí•œ Alexander ë…ì‚´ ì‚¬ê±´ì„ í•´ê²°í•˜ì„¸ìš”
        </p>
    </div>
    """)

    with gr.Row():
        with gr.Column(scale=3):
            # ì±„íŒ… í™”ë©´
            chat_display = gr.HTML(
                value=game.create_chat_html(),
                label="ì‹¬ë¬¸ì‹¤"
            )

            # ì‹¬ë¬¸ì‹¤ ì •ë³´ íŒ¨ë„
            interrogation_info = gr.HTML(
                value=game.get_interrogation_info_html('Elena'),
                label=""
            )

            # ë©”ì‹œì§€ ì…ë ¥
            with gr.Row():
                message_input = gr.Textbox(
                    placeholder="ìš©ì˜ìì—ê²Œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...",
                    label="",
                    scale=4,
                    container=False
                )
                send_btn = gr.Button("ğŸ” ì§ˆë¬¸", variant="primary", scale=1)

            # ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ë“¤
            gr.Markdown("**ğŸ’­ ë¹ ë¥¸ ì§ˆë¬¸:**")
            with gr.Row():
                quick1 = gr.Button("ì‚¬ê±´ ë‹¹ì¼ ì–´ë””ì— ìˆì—ˆë‚˜?", size="sm")
                quick2 = gr.Button("Alexanderì™€ ì–´ë–¤ ê´€ê³„ì˜€ë‚˜?", size="sm")
            with gr.Row():
                quick3 = gr.Button("ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í–‰ë™ì„ ë³¸ ì  ìˆë‚˜?", size="sm")
                quick4 = gr.Button("ìˆ¨ê¸°ê³  ìˆëŠ” ê²Œ ìˆë‹¤ë©´ ë§í•´ë‹¬ë¼", size="sm")

        with gr.Column(scale=1):
            # ìš©ì˜ì ì„ íƒ íŒ¨ë„
            gr.Markdown("### ğŸ¤– ìš©ì˜ì ì„ íƒ")

            suspect_choice = gr.Radio(
                choices=[
                    ("Elena (ì•„ë‚´)", "Elena"),
                    ("IRIS-01 (ê°€ì •ë¶€ ë¡œë´‡)", "IRIS-01"),
                    ("Dr. Chen (ê°œë°œì)", "Dr. Chen"),
                    ("ZEN (ë³´ì•ˆ AI)", "ZEN")
                ],
                value="Elena",
                label="ì‹¬ë¬¸í•  ìš©ì˜ì",
                info="ê° ìš©ì˜ìë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ìºë¦­í„° ì´ë¯¸ì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤"
            )

            # ì„ íƒëœ ìºë¦­í„° ì •ë³´ í‘œì‹œ
            with gr.Group():
                character_info = gr.HTML(
                    value=game.get_character_info_html('Elena'),
                    label=""
                )

            # ìµœì¢… ë³´ê³ ì„œ ì‹œìŠ¤í…œ
            gr.Markdown("### ğŸ¯ ìµœì¢… ë³´ê³ ì„œ")

            submit_report_btn = gr.Button(
                "ğŸ“‹ ìµœì¢… ë³´ê³ ì„œ ì œì¶œ",
                variant="primary",
                size="lg",
                visible=True
            )

            # ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ í‘œì‹œ
            report_status = gr.HTML(
                value=game.get_report_status_html(),
                label=""
            )

            # ëª¨ë‹¬ HTML ì»¨í…Œì´ë„ˆ
            modal_container = gr.HTML(
                value="",
                label="",
                visible=False
            )

            gr.Markdown("### ğŸ“Š ìˆ˜ì‚¬ ë„êµ¬")

            case_summary_btn = gr.Button("ğŸ“‹ ìˆ˜ì‚¬ í˜„í™©", variant="secondary")
            case_summary_output = gr.Textbox(
                label="ìˆ˜ì‚¬ ë¦¬í¬íŠ¸",
                lines=12,
                interactive=False,
                visible=False
            )

            clear_btn = gr.Button("ğŸ”„ ìˆ˜ì‚¬ ì´ˆê¸°í™”", variant="stop")

    # ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    send_btn.click(
        interrogate_and_update_info,
        inputs=[message_input, suspect_choice],
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

    message_input.submit(
        interrogate_and_update_info,
        inputs=[message_input, suspect_choice],
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

    # ë¹ ë¥¸ ì§ˆë¬¸ ë²„íŠ¼ë“¤
    def send_quick_question(question: str, suspect: str):
        """ë¹ ë¥¸ ì§ˆë¬¸ ì „ì†¡"""
        return interrogate_and_update_info(question, suspect)

    quick1.click(
        lambda s: send_quick_question("ì‚¬ê±´ ë‹¹ì¼ ì–´ë””ì— ìˆì—ˆë‚˜?", s),
        inputs=[suspect_choice],
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

    quick2.click(
        lambda s: send_quick_question("Alexanderì™€ ì–´ë–¤ ê´€ê³„ì˜€ë‚˜?", s),
        inputs=[suspect_choice],
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

    quick3.click(
        lambda s: send_quick_question("ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í–‰ë™ì„ ë³¸ ì  ìˆë‚˜?", s),
        inputs=[suspect_choice],
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

    quick4.click(
        lambda s: send_quick_question("ìˆ¨ê¸°ê³  ìˆëŠ” ê²Œ ìˆë‹¤ë©´ ë§í•´ë‹¬ë¼", s),
        inputs=[suspect_choice],
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

    # ìš©ì˜ì ë³€ê²½
    suspect_choice.change(
        update_character_info_and_display,
        inputs=[suspect_choice],
        outputs=[character_info, interrogation_info, chat_display]
    )

    # ìµœì¢… ë³´ê³ ì„œ
    submit_report_btn.click(
        get_report_modal_html,
        outputs=[modal_container, modal_container]
    )

    # ìˆ˜ì‚¬ ë„êµ¬
    case_summary_btn.click(
        lambda: (game.get_case_summary(), gr.update(visible=True)),
        outputs=[case_summary_output, case_summary_output]
    )

    clear_btn.click(
        clear_game,
        outputs=[chat_display, message_input, interrogation_info, report_status]
    )

# ì¸í„°í˜ì´ìŠ¤ ì‹¤í–‰
if __name__ == "__main__":
    demo.launch(share=True, debug=True)